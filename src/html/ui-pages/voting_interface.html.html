<?xml version="1.0" encoding="utf-8"?>
<j:jelly trim="false" xmlns:j="jelly:core" xmlns:g="glide">
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planning Poker - Bridge Console</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&amp;family=Share+Tech+Mono&amp;family=Rajdhani:wght@300;400;500;600;700&amp;display=swap');

        :root {
            --primary-color: #00d4ff;
            --primary-glow: rgba(0, 212, 255, 0.4);
            --secondary-color: #0a0e17;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --danger-color: #ff3366;
            --dark-color: #c8d6e5;
            --light-color: rgba(10, 14, 27, 0.85);
            --border-color: rgba(0, 212, 255, 0.2);
            --shadow: 0 0 20px rgba(0, 212, 255, 0.15), 0 0 60px rgba(0, 212, 255, 0.05);
            --radius: 4px;
            --lcars-orange: #ff9900;
            --lcars-purple: #cc99cc;
            --lcars-blue: #9999ff;
            --lcars-red: #cc6666;
            --saber-blue: #4488ff;
            --saber-green: #44ff66;
            --grid-color: rgba(0, 212, 255, 0.06);
        }

        @keyframes gridScroll {
            0% { background-position: 0 0; }
            100% { background-position: 0 50px; }
        }
        @keyframes pulseGlow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        @keyframes scanline {
            0% { top: -5%; }
            100% { top: 105%; }
        }
        @keyframes warpIn {
            0% { transform: scale(0.8) translateY(20px); opacity: 0; filter: blur(8px); }
            60% { transform: scale(1.02) translateY(-2px); opacity: 1; filter: blur(0); }
            100% { transform: scale(1) translateY(0); opacity: 1; filter: blur(0); }
        }
        @keyframes borderTrace {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100vh;
            overflow: hidden;
        }

        body {
            font-family: 'Rajdhani', 'Share Tech Mono', monospace;
            background-color: #050810;
            color: var(--dark-color);
            line-height: 1.6;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridScroll 8s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            left: 0; right: 0;
            height: 4px;
            background: linear-gradient(180deg, transparent, rgba(0, 212, 255, 0.08), transparent);
            animation: scanline 6s linear infinite;
            pointer-events: none;
            z-index: 9999;
            width: 100%;
            display: none;
        }

        body.scanlines-on::after {
            display: block;
        }

        #starfield {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .header {
            background: linear-gradient(135deg, rgba(10, 14, 30, 0.95), rgba(15, 20, 40, 0.95));
            border-bottom: 2px solid var(--primary-color);
            padding: 0;
            display: flex;
            align-items: stretch;
            box-shadow: 0 2px 30px rgba(0, 212, 255, 0.2);
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-color), var(--lcars-orange), var(--lcars-purple), var(--primary-color), transparent);
            background-size: 200% 100%;
            animation: borderTrace 4s linear infinite;
        }

        .lcars-bar {
            display: flex;
            align-items: stretch;
            gap: 3px;
            margin-right: 1rem;
        }

        .lcars-block { width: 12px; min-height: 100%; }
        .lcars-block:nth-child(1) { background: var(--lcars-orange); border-radius: 0 0 8px 0; }
        .lcars-block:nth-child(2) { background: var(--lcars-purple); }
        .lcars-block:nth-child(3) { background: var(--lcars-blue); border-radius: 0 8px 0 0; }

        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 1;
            padding: 0.8rem 1.5rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-glow);
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: pulseGlow 3s ease-in-out infinite;
        }

        .session-code {
            font-family: 'Share Tech Mono', monospace;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 212, 255, 0.05));
            color: var(--primary-color);
            padding: 0.4rem 0.8rem;
            border-radius: var(--radius);
            font-weight: bold;
            cursor: pointer;
            border: 1px solid rgba(0, 212, 255, 0.3);
            letter-spacing: 2px;
            font-size: 0.85rem;
            text-shadow: 0 0 5px var(--primary-glow);
            transition: all 0.2s;
        }

        .session-code:hover {
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1.2rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            cursor: pointer;
            font-family: 'Rajdhani', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.25s ease;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            position: relative;
            overflow: hidden;
            background: transparent;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before { left: 100%; }

        .btn-primary {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(0, 212, 255, 0.05));
            border-color: var(--primary-color); color: var(--primary-color);
        }
        .btn-primary:hover { box-shadow: 0 0 20px var(--primary-glow); }
        .btn-success {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05));
            border-color: var(--success-color); color: var(--success-color);
        }
        .btn-success:hover { box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
        .btn-warning {
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.15), rgba(255, 170, 0, 0.05));
            border-color: var(--warning-color); color: var(--warning-color);
        }
        .btn-danger {
            background: linear-gradient(135deg, rgba(255, 51, 102, 0.15), rgba(255, 51, 102, 0.05));
            border-color: var(--danger-color); color: var(--danger-color);
        }
        .btn-secondary {
            background: linear-gradient(135deg, rgba(200, 214, 229, 0.1), rgba(200, 214, 229, 0.03));
            border-color: rgba(200, 214, 229, 0.3); color: var(--dark-color);
        }

        .btn:hover { transform: translateY(-1px); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .main-content {
            display: flex;
            height: calc(100vh - 65px);
            gap: 1rem;
            padding: 1rem 2rem;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        .story-panel {
            flex: 2;
            background: linear-gradient(145deg, rgba(10, 18, 35, 0.9), rgba(5, 10, 20, 0.95));
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            overflow-y: auto;
            position: relative;
        }

        .story-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--lcars-orange), var(--lcars-purple));
            background-size: 200% 100%;
            animation: borderTrace 6s linear infinite;
        }

        .sidebar {
            flex: 1;
            max-width: 400px;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow: hidden;
        }

        .session-card {
            background: linear-gradient(145deg, rgba(10, 18, 35, 0.9), rgba(5, 10, 20, 0.95));
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .session-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--lcars-orange), var(--lcars-purple));
            background-size: 200% 100%;
            animation: borderTrace 6s linear infinite;
        }

        .session-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #e8f0fe;
            letter-spacing: 1px;
        }

        .status-badge {
            display: inline-block;
            padding: 0.2rem 0.75rem;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 1px solid;
        }

        .status-ready {
            background: rgba(153, 153, 255, 0.1);
            color: var(--lcars-blue);
            border-color: rgba(153, 153, 255, 0.3);
        }
        .status-live {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success-color);
            border-color: rgba(0, 255, 136, 0.3);
            animation: pulseGlow 2s ease-in-out infinite;
        }
        .status-completed {
            background: rgba(0, 212, 255, 0.1);
            color: var(--primary-color);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .dealer-controls {
            background: linear-gradient(145deg, rgba(10, 18, 35, 0.9), rgba(5, 10, 20, 0.95));
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .story-card {
            background: linear-gradient(145deg, rgba(10, 18, 35, 0.9), rgba(5, 10, 20, 0.95));
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .story-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--lcars-orange), var(--primary-color));
        }

        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .story-number {
            font-family: 'Share Tech Mono', monospace;
            font-size: 1rem;
            color: var(--lcars-orange);
            font-weight: bold;
        }

        .story-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #e8f0fe;
            letter-spacing: 1px;
        }

        .story-description {
            margin-bottom: 1.5rem;
            line-height: 1.6;
            font-family: 'Rajdhani', monospace;
            color: rgba(200, 214, 229, 0.7);
        }

        .acceptance-criteria {
            background: rgba(0, 212, 255, 0.04);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
        }

        .acceptance-criteria h4 {
            margin-bottom: 0.5rem;
            font-family: 'Share Tech Mono', monospace;
            color: var(--lcars-orange);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.8rem;
        }

        .voting-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
            padding: 0 1rem;
        }

        .voting-card {
            background: linear-gradient(145deg, rgba(10, 18, 35, 0.9), rgba(5, 10, 20, 0.95));
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--dark-color);
            position: relative;
            overflow: hidden;
        }

        .voting-card::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            transition: left 0.4s;
        }
        .voting-card:hover::before { left: 100%; }

        .voting-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 0 25px var(--primary-glow);
            color: var(--primary-color);
            text-shadow: 0 0 8px var(--primary-glow);
        }

        .voting-card.selected {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 212, 255, 0.08));
            color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 30px var(--primary-glow), inset 0 0 20px rgba(0, 212, 255, 0.1);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .voting-card.special {
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.15), rgba(255, 170, 0, 0.05));
            border-color: rgba(255, 170, 0, 0.3);
            color: var(--warning-color);
        }

        .sidebar-section {
            background: linear-gradient(145deg, #0b1628, #060c18);
            border: 1px solid rgba(0, 212, 255, 0.25);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .sidebar-section.flex-fill {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            flex-shrink: 1;
        }

        .sidebar-section.flex-fill > .section-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }

        .sidebar-section::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--lcars-purple));
        }

        .section-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.15);
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        .section-content {
            padding: 0.75rem 1rem;
            background: #080e1c;
        }

        .participant-list {
            list-style: none;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.5rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            border-radius: 3px;
            transition: background 0.15s;
        }

        .participant-item:hover {
            background: rgba(0, 212, 255, 0.04);
        }

        .participant-item:last-child {
            border-bottom: none;
        }

        .participant-name {
            font-family: 'Rajdhani', monospace;
            font-weight: 600;
            font-size: 1.05rem;
            color: #e8f0fe;
            letter-spacing: 0.3px;
        }

        .participant-role {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            padding: 0.2rem 0.55rem;
            border-radius: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .participant-role[data-role='dealer'],
        .participant-role {
            background: rgba(0, 212, 255, 0.15);
            color: #66e0ff;
            border: 1px solid rgba(0, 212, 255, 0.35);
        }

        .vote-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 212, 255, 0.08);
            border: 2px solid rgba(0, 212, 255, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--primary-color);
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .vote-indicator.voted {
            background: rgba(0, 255, 136, 0.25);
            border-color: var(--success-color);
            color: var(--success-color);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
        }

        .vote-results {
            margin-bottom: 1rem;
        }

        .vote-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            text-align: center;
            padding: 0.75rem;
            background: rgba(0, 212, 255, 0.04);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
        }

        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .stat-label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem;
            color: rgba(200, 214, 229, 0.4);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .vote-distribution {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .vote-chip {
            font-family: 'Share Tech Mono', monospace;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: var(--primary-color);
            padding: 0.25rem 0.6rem;
            border-radius: 2px;
            font-size: 0.75rem;
            letter-spacing: 1px;
        }

        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }

        .modal-content {
            background: linear-gradient(160deg, rgba(10, 18, 35, 0.97), rgba(5, 10, 22, 0.98));
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: var(--radius);
            max-width: 600px;
            width: 92%;
            max-height: 82vh;
            overflow-y: auto;
            box-shadow: 0 0 60px rgba(0, 212, 255, 0.15);
            animation: warpIn 0.3s ease-out;
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--lcars-orange), var(--primary-color), var(--lcars-purple));
            background-size: 200% 100%;
            animation: borderTrace 3s linear infinite;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-color);
            text-shadow: 0 0 8px var(--primary-glow);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .modal-body { padding: 1.5rem; }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .form-group { margin-bottom: 1rem; }

        .form-label {
            display: block;
            margin-bottom: 0.4rem;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            color: var(--lcars-orange);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .form-control {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: rgba(0, 212, 255, 0.04);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-family: 'Rajdhani', monospace;
            font-size: 0.95rem;
            color: var(--dark-color);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
            background: rgba(0, 212, 255, 0.08);
        }

        .form-control option {
            background: #0a0e17;
            color: var(--dark-color);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .toast {
            position: fixed;
            top: 20px; right: 20px;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85rem;
            letter-spacing: 1px;
            border: 1px solid;
            backdrop-filter: blur(10px);
            pointer-events: none;
        }
        .toast.show { transform: translateX(0); pointer-events: auto; }

        .toast-success {
            background: rgba(0, 255, 136, 0.15);
            border-color: var(--success-color);
            color: var(--success-color);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
        }
        .toast-error {
            background: rgba(255, 51, 102, 0.15);
            border-color: var(--danger-color);
            color: var(--danger-color);
            box-shadow: 0 0 30px rgba(255, 51, 102, 0.2);
        }
        .toast-info {
            background: rgba(0, 212, 255, 0.15);
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.2);
        }

        .collapsible { cursor: pointer; }
        .collapsed .section-content { display: none; }

        .theme-toggle {
            background: rgba(255, 153, 0, 0.1);
            border: 1px solid var(--lcars-orange);
            border-radius: 50%;
            width: 36px; height: 36px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--lcars-orange);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle:hover {
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.3);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); }
        ::-webkit-scrollbar-thumb { background: rgba(0, 212, 255, 0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0, 212, 255, 0.5); }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: 1rem;
            }
            .sidebar { max-width: none; }
            .header-inner { padding: 0.5rem 1rem; flex-wrap: wrap; gap: 0.5rem; }
            .lcars-bar { display: none; }
            .voting-cards {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            }
        }
    </style>
</head>
<body>
    <canvas id="starfield"></canvas>

    <div class="header">
        <div class="lcars-bar">
            <div class="lcars-block"></div>
            <div class="lcars-block"></div>
            <div class="lcars-block"></div>
        </div>
        <div class="header-inner">
        <div class="header-left">
            <div class="logo">‚óá Bridge Console</div>
            <button class="btn btn-secondary" id="backBtn">‚Üê Command Deck</button>
            <div class="session-code" id="sessionCode" title="Click to copy join link">
                Loading...
            </div>
        </div>
        <div class="header-right">
            <button class="btn btn-secondary" id="roleSwitch" style="display: none;">
                Switch Role
            </button>
            <button class="theme-toggle" id="themeToggle" title="Red Alert Mode">
                üî¥
            </button>
        </div>
        </div>
    </div>

    <div class="main-content">
        <div class="story-panel">
            <!-- Session Info Card -->
            <div class="session-card">
                <div class="session-title" id="sessionTitle">Loading...</div>
                <span class="status-badge" id="sessionStatus">Ready</span>
                <div id="sessionDescription" style="margin-top: 0.5rem; color: rgba(200, 214, 229, 0.5); font-family: 'Share Tech Mono', monospace; font-size: 0.85rem;"></div>
            </div>

            <!-- Dealer Controls (visible only to dealers) -->
            <div class="dealer-controls" id="dealerControls" style="display: none;">
                <button class="btn btn-success" id="startVotingBtn">‚óá Engage Voting</button>
                <button class="btn btn-primary" id="revealVotesBtn">‚óá Decloak Votes</button>
                <button class="btn btn-warning" id="resetVotesBtn">‚Ü∫ Reset Sensors</button>
                <button class="btn btn-secondary" id="skipStoryBtn">‚è≠ Bypass Objective</button>
                <button class="btn btn-success" id="completeStoryBtn">‚óÜ Lock Estimate</button>
            </div>

            <!-- Current Story -->
            <div class="story-card" id="currentStoryCard" style="display: none;">
                <div class="story-header">
                    <span class="story-number" id="storyNumber">#123</span>
                    <div id="storyPresenter" style="font-size: 0.8rem; color: rgba(200, 214, 229, 0.5); font-family: 'Share Tech Mono', monospace;"></div>
                </div>
                <div class="story-title" id="storyTitle">Story Title</div>
                <div class="story-description" id="storyDescription">Story description goes here...</div>
                <div class="acceptance-criteria" id="acceptanceCriteria" style="display: none;">
                    <h4>Acceptance Criteria</h4>
                    <div id="acceptanceCriteriaContent"></div>
                </div>
                <div id="dealerComments" style="display: none;">
                    <h4>Dealer Comments</h4>
                    <div id="dealerCommentsContent"></div>
                </div>
            </div>

            <!-- Voting Cards -->
            <div class="voting-cards" id="votingCards"></div>
        </div>

        <div class="sidebar">
            <!-- Vote Results -->
            <div class="sidebar-section" id="voteResultsSection" style="display: none;">
                <div class="section-header">
                    <span>Vote Results</span>
                </div>
                <div class="section-content">
                    <div class="vote-summary" id="voteSummary"></div>
                    <div class="vote-distribution" id="voteDistribution"></div>
                </div>
            </div>

            <!-- Dealers -->
            <div class="sidebar-section">
                <div class="section-header collapsible" data-target="dealersContent">
                    <span>Officers</span>
                    <span>‚ñº</span>
                </div>
                <div class="section-content" id="dealersContent" style="max-height: 280px; overflow-y: auto;">
                    <ul class="participant-list" id="dealersList"></ul>
                </div>
            </div>

            <!-- Participants -->
            <div class="sidebar-section">
                <div class="section-header">
                    <span>Crew</span>
                    <span id="participantCount">0</span>
                </div>
                <div class="section-content" style="max-height: 300px; overflow-y: auto;">
                    <ul class="participant-list" id="participantsList"></ul>
                </div>
            </div>

            <!-- Story Queue -->
            <div class="sidebar-section flex-fill">
                <div class="section-header collapsible" data-target="storyQueueContent">
                    <span>Mission Queue</span>
                    <span>‚ñº</span>
                </div>
                <div class="section-content" id="storyQueueContent">
                    <div id="storyQueue"></div>
                </div>
                <div style="padding: 0.5rem 1rem; border-top: 1px solid rgba(0,212,255,0.15); background: #080e1c; flex-shrink: 0;">
                    <button class="btn btn-primary btn-sm" id="addStoryBtn" style="width: 100%; padding: 0.6rem;">
                        + Add Objective
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="addStoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Objective</h3>
                <button class="btn btn-secondary" data-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Scan Objectives</label>
                    <input type="text" class="form-control" id="storySearch" placeholder="Search by title or number...">
                </div>
                <div id="storySearchResults"></div>
                <hr />
                <div class="form-group">
                    <label class="form-label">Quick Deploy</label>
                    <input type="text" class="form-control" id="quickStoryTitle" placeholder="Story title">
                    <textarea class="form-control" id="quickStoryDescription" placeholder="Story description" style="margin-top: 0.5rem;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="addSelectedStoriesBtn">Add Selected</button>
                <button class="btn btn-success" id="quickAddStoryBtn">Quick Add</button>
            </div>
        </div>
    </div>

    <div class="modal" id="skipStoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Bypass Objective</h3>
                <button class="btn btn-secondary" data-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Bypass Rationale (Optional)</label>
                    <textarea class="form-control" id="skipComments" placeholder="Enter reason for skipping this story..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-warning" id="confirmSkipStoryBtn">Confirm Bypass</button>
            </div>
        </div>
    </div>

    <div class="modal" id="completeStoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Lock Estimate</h3>
                <button class="btn btn-secondary" data-dismiss="modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Final Complexity Rating</label>
                    <select class="form-control" id="finalStoryPoints">
                        <option value="">Select points...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Mission Notes (Optional)</label>
                    <textarea class="form-control" id="completionComments" placeholder="Add any notes about the estimation..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-success" id="confirmCompleteStoryBtn">‚óÜ Lock Estimate</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- Hidden form for navigation -->
    <form id="navigationForm" method="post" style="display: none;">
        <input type="hidden" name="sysparm_goto_url" value="" />
    </form>

    <script>
        // Jelly-resolved variables (must remain outside CDATA)
        var currentUser = {
            id: '${gs.getUserID()}',
            name: '${gs.getUserName()}'
        };
    </script>
    <script>
    //<![CDATA[
        // Star field
        (function() {
            var canvas = document.getElementById('starfield');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            var stars = [];
            function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
            resize();
            window.addEventListener('resize', resize);
            for (var i = 0; i < 120; i++) {
                stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * 1.5 + 0.3, s: Math.random() * 0.3 + 0.05, a: Math.random() });
            }
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                stars.forEach(function(st) {
                    st.a += st.s * 0.02;
                    var alpha = 0.3 + Math.sin(st.a) * 0.4;
                    ctx.beginPath();
                    ctx.arc(st.x, st.y, st.r, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(0, 212, 255, ' + Math.max(0.1, alpha) + ')';
                    ctx.fill();
                });
                requestAnimationFrame(draw);
            }
            draw();
        })();

        // Safe AJAX response parser
        function parseAjaxResponse(response) {
            try {
                // Handle string response (from getXMLAnswer)
                if (typeof response === 'string') {
                    console.log('[DEBUG parseAjax] Got string response, length:', response ? response.length : 0);
                    return response ? JSON.parse(response) : null;
                }
                console.log('[DEBUG parseAjax] Got XML response object:', response);
                console.log('[DEBUG parseAjax] response.responseText (first 500):', (response.responseText || '').substring(0, 500));
                var xml = response.responseXML;
                if (!xml) { console.warn('[DEBUG parseAjax] No responseXML'); return null; }
                var answer = xml.documentElement.getAttribute('answer');
                console.log('[DEBUG parseAjax] documentElement.answer:', answer ? answer.substring(0, 200) : null);
                if (!answer) {
                    var answerEl = xml.getElementsByTagName('answer');
                    console.log('[DEBUG parseAjax] <answer> elements found:', answerEl ? answerEl.length : 0);
                    if (answerEl && answerEl.length > 0) {
                        answer = answerEl[0].textContent || answerEl[0].text;
                    }
                }
                if (!answer) {
                    var resultEl = xml.getElementsByTagName('result');
                    console.log('[DEBUG parseAjax] <result> elements found:', resultEl ? resultEl.length : 0);
                    if (resultEl && resultEl.length > 0) {
                        answer = resultEl[0].getAttribute('answer');
                    }
                }
                if (!answer) { console.warn('[DEBUG parseAjax] No answer found in any location'); return null; }
                var parsed = JSON.parse(answer);
                console.log('[DEBUG parseAjax] Parsed result:', parsed);
                return parsed;
            } catch (e) {
                console.error('[DEBUG parseAjax] Error parsing AJAX response:', e);
                return null;
            }
        }

        // Global variables
        var sessionData = null;
        var pollInterval = null;
        var sessionId = getUrlParameter('session_id');
        var storySearchDebounce = null;
        var selectedStoryIds = [];

        // Initialize page
        (function() { if (/[?&]scan\b/.test(location.search)) document.body.classList.add('scanlines-on'); })();
        document.addEventListener('DOMContentLoaded', function() {
            if (!sessionId) {
                showToast('Session ID not provided', 'error');
                return;
            }
            
            initializeEventListeners();
            loadSession();
            startPolling();
        });
        
        // Event listeners setup
        function initializeEventListeners() {
            // Header controls
            document.getElementById('backBtn').addEventListener('click', function() {
                window.location.href = 'session_management.do';
            });
            
            document.getElementById('sessionCode').addEventListener('click', copyJoinLink);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('roleSwitch').addEventListener('click', switchRole);
            
            // Dealer controls
            document.getElementById('startVotingBtn').addEventListener('click', startVoting);
            document.getElementById('revealVotesBtn').addEventListener('click', revealVotes);
            document.getElementById('resetVotesBtn').addEventListener('click', resetVotes);
            document.getElementById('skipStoryBtn').addEventListener('click', function() {
                showModal('skipStoryModal');
            });
            document.getElementById('completeStoryBtn').addEventListener('click', function() {
                showModal('completeStoryModal');
            });
            
            // Modal actions
            document.getElementById('confirmSkipStoryBtn').addEventListener('click', skipStory);
            document.getElementById('confirmCompleteStoryBtn').addEventListener('click', completeStory);
            
            // Modal dismiss
            var dismissBtns = document.querySelectorAll('[data-dismiss="modal"]');
            dismissBtns.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    hideAllModals();
                });
            });
            
            // Add Objective button - opens modal
            document.getElementById('addStoryBtn').addEventListener('click', function() {
                selectedStoryIds = [];
                document.getElementById('storySearchResults').innerHTML = '';
                document.getElementById('storySearch').value = '';
                document.getElementById('quickStoryTitle').value = '';
                document.getElementById('quickStoryDescription').value = '';
                showModal('addStoryModal');
            });
            
            // Story search input with debounce
            document.getElementById('storySearch').addEventListener('input', function() {
                clearTimeout(storySearchDebounce);
                var term = this.value.trim();
                if (term.length < 2) {
                    document.getElementById('storySearchResults').innerHTML = '';
                    return;
                }
                storySearchDebounce = setTimeout(function() {
                    searchStoriesForVoting(term);
                }, 300);
            });
            
            // Add Selected stories button
            document.getElementById('addSelectedStoriesBtn').addEventListener('click', addSelectedStoriesToSession);
            
            // Quick Add manual story button
            document.getElementById('quickAddStoryBtn').addEventListener('click', quickAddStoryToSession);
            
            // Collapsible sections
            var collapsibles = document.querySelectorAll('.collapsible');
            collapsibles.forEach(function(elem) {
                elem.addEventListener('click', function() {
                    var targetId = elem.getAttribute('data-target');
                    var target = document.getElementById(targetId);
                    var section = elem.closest('.sidebar-section');
                    
                    section.classList.toggle('collapsed');
                    var arrow = elem.querySelector('span:last-child');
                    arrow.textContent = section.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
                });
            });
        }
        
        // Load session data
        function loadSession() {
            var ga = new GlideAjax('PlanningPokerSessionAjax');
            ga.addParam('sysparm_name', 'getSession');
            ga.addParam('session_id', sessionId);
            ga.getXML(function(response) {
                var result = parseAjaxResponse(response);
                if (!result) { showToast('Comm link failure ‚Äî unable to load session', 'error'); return; }
                
                if (result.success) {
                    sessionData = result.data;
                    renderSession();
                } else {
                    showToast(result.message, 'error');
                }
            });
        }
        
        // Render session data
        function renderSession() {
            if (!sessionData) return;
            
            var session = sessionData.session;
            var currentStory = sessionData.currentStory;
            var participants = sessionData.participants;
            var scoringValues = sessionData.scoringValues;
            var userRole = sessionData.userRole;
            var revealedVotes = sessionData.revealedVotes;
            
            // Update header
            document.getElementById('sessionCode').textContent = session.sessionCode;
            document.getElementById('sessionTitle').textContent = session.name;
            document.getElementById('sessionStatus').textContent = session.status;
            document.getElementById('sessionStatus').className = 'status-badge status-' + session.status;
            
            if (session.description) {
                document.getElementById('sessionDescription').textContent = session.description;
            }
            
            // Show role switch if applicable
            if (userRole.canSwitchToVoter || userRole.canSwitchToDealer) {
                var roleSwitchBtn = document.getElementById('roleSwitch');
                roleSwitchBtn.style.display = 'block';
                roleSwitchBtn.textContent = userRole.effectiveRole === 'dealer' ? 'Switch to Voter' : 'Switch to Dealer';
            }
            
            // Show dealer controls if user can manage
            if (userRole.effectiveRole === 'dealer' || userRole.isDealer) {
                document.getElementById('dealerControls').style.display = 'block';
                updateDealerControls(currentStory);
            }
            
            // Render current story
            if (currentStory) {
                renderCurrentStory(currentStory);
                renderVotingCards(scoringValues, currentStory);
                
                if (revealedVotes) {
                    renderVoteResults(revealedVotes);
                }
            } else {
                document.getElementById('currentStoryCard').style.display = 'none';
                document.getElementById('votingCards').innerHTML = '<p style="text-align: center; color: rgba(200, 214, 229, 0.4); padding: 2rem; font-family: Share Tech Mono, monospace; letter-spacing: 1px;">// No active objective. Standing by for orders.</p>';
            }
            
            // Render participants
            renderParticipants(participants);
            
            // Render story queue
            renderStoryQueue(sessionData.storyQueue || []);
        }
        
        // Render current story
        function renderCurrentStory(story) {
            document.getElementById('currentStoryCard').style.display = 'block';
            document.getElementById('storyNumber').textContent = story.story_number || 'N/A';
            document.getElementById('storyTitle').textContent = story.story_title || 'Untitled Story';
            document.getElementById('storyDescription').innerHTML = story.story_description || 'No description provided.';
            
            if (story.acceptance_criteria) {
                document.getElementById('acceptanceCriteria').style.display = 'block';
                document.getElementById('acceptanceCriteriaContent').innerHTML = story.acceptance_criteria;
            } else {
                document.getElementById('acceptanceCriteria').style.display = 'none';
            }
            
            if (story.dealer_comments) {
                document.getElementById('dealerComments').style.display = 'block';
                document.getElementById('dealerCommentsContent').textContent = story.dealer_comments;
            } else {
                document.getElementById('dealerComments').style.display = 'none';
            }
            
            if (story.presenter) {
                document.getElementById('storyPresenter').textContent = 'Presented by: ' + story.presenter;
            }
        }
        
        // Render voting cards
        function renderVotingCards(scoringValues, currentStory) {
            var votingCardsContainer = document.getElementById('votingCards');
            votingCardsContainer.innerHTML = '';
            
            if (!currentStory || currentStory.status !== 'voting') {
                votingCardsContainer.innerHTML = '<p style="text-align: center; color: rgba(200, 214, 229, 0.4); padding: 2rem; font-family: Share Tech Mono, monospace; letter-spacing: 1px;">// Estimation array offline. Awaiting commanding officer.</p>';
                return;
            }
            
            scoringValues.forEach(function(value) {
                var card = document.createElement('div');
                card.className = 'voting-card';
                if (value.isSpecial) {
                    card.className += ' special';
                }
                
                card.textContent = value.displayValue;
                card.addEventListener('click', function() {
                    castVote(value.displayValue);
                    
                    // Update UI immediately
                    document.querySelectorAll('.voting-card').forEach(function(c) {
                        c.classList.remove('selected');
                    });
                    card.classList.add('selected');
                });
                
                votingCardsContainer.appendChild(card);
            });
        }
        
        // Cast vote
        function castVote(voteValue) {
            var currentStory = sessionData.currentStory;
            if (!currentStory) {
                showToast('No active story', 'error');
                return;
            }
            
            var ga = new GlideAjax('PlanningPokerVotingAjax');
            ga.addParam('sysparm_name', 'castVote');
            ga.addParam('session_id', sessionId);
            ga.addParam('story_id', currentStory.sys_id);
            ga.addParam('vote_value', voteValue);
            ga.getXML(function(response) {
                var result = parseAjaxResponse(response);
                if (!result) { return; }
                
                if (result.success) {
                    showToast('Vote registered: ' + voteValue, 'success');
                } else {
                    showToast(result.message, 'error');
                }
            });
        }
        
        // Polling for real-time updates
        function startPolling() {
            pollInterval = setInterval(function() {
                if (sessionData && sessionData.currentStory && sessionData.currentStory.status === 'voting') {
                    pollVotingStatus();
                }
            }, 3000);
        }
        
        function pollVotingStatus() {
            var ga = new GlideAjax('PlanningPokerSessionAjax');
            ga.addParam('sysparm_name', 'getVotingStatus');
            ga.addParam('session_id', sessionId);
            ga.getXML(function(response) {
                var result = parseAjaxResponse(response);
                if (!result) { return; }
                
                if (result.success && result.data.hasCurrentStory) {
                    updateVotingIndicators(result.data.participants);
                }
            });
        }
        
        // Update voting indicators
        function updateVotingIndicators(participants) {
            participants.forEach(function(participant) {
                var indicator = document.getElementById('vote-indicator-' + participant.userId);
                if (indicator) {
                    if (participant.hasVoted) {
                        indicator.classList.add('voted');
                        indicator.textContent = '‚úì';
                    } else {
                        indicator.classList.remove('voted');
                        indicator.textContent = '';
                    }
                }
            });
        }
        
        // Render participants
        function renderParticipants(participants) {
            var dealersList = document.getElementById('dealersList');
            var participantsList = document.getElementById('participantsList');
            var participantCount = document.getElementById('participantCount');
            
            dealersList.innerHTML = '';
            participantsList.innerHTML = '';
            
            var dealers = participants.filter(function(p) { return p.role === 'dealer'; });
            var others = participants.filter(function(p) { return p.role !== 'dealer'; });
            
            // Render dealers
            dealers.forEach(function(participant) {
                var li = createParticipantItem(participant);
                dealersList.appendChild(li);
            });
            
            // Render other participants
            others.forEach(function(participant) {
                var li = createParticipantItem(participant);
                participantsList.appendChild(li);
            });
            
            participantCount.textContent = participants.length;
        }
        
        function createParticipantItem(participant) {
            var li = document.createElement('li');
            li.className = 'participant-item';
            
            var nameDiv = document.createElement('div');
            nameDiv.className = 'participant-name';
            nameDiv.textContent = participant.firstName + ' ' + participant.lastName;
            
            var roleSpan = document.createElement('span');
            roleSpan.className = 'participant-role';
            roleSpan.textContent = participant.role;
            
            var indicator = document.createElement('div');
            indicator.className = 'vote-indicator';
            indicator.id = 'vote-indicator-' + participant.userId;
            
            if (participant.hasVoted) {
                indicator.classList.add('voted');
                indicator.textContent = '‚úì';
            }
            
            var leftDiv = document.createElement('div');
            leftDiv.appendChild(nameDiv);
            leftDiv.appendChild(roleSpan);
            
            li.appendChild(leftDiv);
            li.appendChild(indicator);
            
            return li;
        }
        
        // Dealer actions
        function startVoting() {
            var currentStory = sessionData.currentStory;
            if (!currentStory) {
                showToast('No story selected', 'error');
                return;
            }
            
            var ga = new GlideAjax('PlanningPokerStoryAjax');
            ga.addParam('sysparm_name', 'startVoting');
            ga.addParam('session_id', sessionId);
            ga.addParam('story_id', currentStory.sys_id);
            ga.getXML(function(response) {
                var result = parseAjaxResponse(response);
                if (!result) { showToast('Comm failure ‚Äî unable to engage', 'error'); return; }
                
                if (result.success) {
                    showToast('Voting engaged', 'success');
                    loadSession(); // Reload to update UI
                } else {
                    showToast(result.message, 'error');
                }
            });
        }
        
        function revealVotes() {
            var currentStory = sessionData.currentStory;
            if (!currentStory) {
                showToast('No story selected', 'error');
                return;
            }
            
            var ga = new GlideAjax('PlanningPokerVotingAjax');
            ga.addParam('sysparm_name', 'revealVotes');
            ga.addParam('session_id', sessionId);
            ga.addParam('story_id', currentStory.sys_id);
            ga.getXML(function(response) {
                var result = parseAjaxResponse(response);
                if (!result) { showToast('Comm failure ‚Äî unable to decloak', 'error'); return; }
                
                if (result.success) {
                    showToast('Votes decloaked', 'success');
                    renderVoteResults(result.data);
                } else {
                    showToast(result.message, 'error');
                }
            });
        }
        
        function resetVotes() {
            var currentStory = sessionData.currentStory;
            if (!currentStory) {
                showToast('No story selected', 'error');
                return;
            }
            
            if (!confirm('Confirm: Purge all registered votes for this objective?')) {
                return;
            }
            
            var ga = new GlideAjax('PlanningPokerVotingAjax');
            ga.addParam('sysparm_name', 'resetVotes');
            ga.addParam('session_id', sessionId);
            ga.addParam('story_id', currentStory.sys_id);
            ga.getXML(function(response) {
                var result = parseAjaxResponse(response);
                if (!result) { showToast('Comm failure ‚Äî unable to reset', 'error'); return; }
                
                if (result.success) {
                    showToast('Sensors reset', 'success');
                    loadSession(); // Reload to update UI
                    hideModal('voteResultsSection');
                } else {
                    showToast(result.message, 'error');
                }
            });
        }
        
        function skipStory() {
            var currentStory = sessionData.currentStory;
            var comments = document.getElementById('skipComments').value;
            
            var ga = new GlideAjax('PlanningPokerStoryAjax');
            ga.addParam('sysparm_name', 'skipStory');
            ga.addParam('session_id', sessionId);
            ga.addParam('story_id', currentStory.sys_id);
            ga.addParam('comments', comments);
            ga.getXML(function(response) {
                var result = parseAjaxResponse(response);
                if (!result) { showToast('Comm failure ‚Äî bypass error', 'error'); return; }
                
                if (result.success) {
                    showToast('Objective bypassed', 'success');
                    hideAllModals();
                    loadSession(); // Reload to update UI
                } else {
                    showToast(result.message, 'error');
                }
            });
        }
        
        function completeStory() {
            var currentStory = sessionData.currentStory;
            var points = document.getElementById('finalStoryPoints').value;
            var comments = document.getElementById('completionComments').value;
            
            if (!points) {
                showToast('Complexity rating required', 'error');
                return;
            }
            
            var ga = new GlideAjax('PlanningPokerStoryAjax');
            ga.addParam('sysparm_name', 'setStoryPoints');
            ga.addParam('session_id', sessionId);
            ga.addParam('story_id', currentStory.sys_id);
            ga.addParam('story_points', points);
            ga.addParam('comments', comments);
            ga.getXML(function(response) {
                var result = parseAjaxResponse(response);
                if (!result) { showToast('Comm failure ‚Äî estimate lock error', 'error'); return; }
                
                if (result.success) {
                    showToast('Estimate locked: ' + points + ' pts', 'success');
                    hideAllModals();
                    loadSession(); // Reload to update UI
                } else {
                    showToast(result.message, 'error');
                }
            });
        }
        
        // Render vote results
        function renderVoteResults(voteData) {
            var voteResultsSection = document.getElementById('voteResultsSection');
            voteResultsSection.style.display = 'block';
            
            var summary = voteData.summary;
            var votes = voteData.votes;
            
            // Render summary statistics
            var summaryHtml = '';
            if (summary.validVotes > 0) {
                summaryHtml += '<div class="stat-card"><div class="stat-value">' + summary.min.display + '</div><div class="stat-label">Min</div></div>';
                summaryHtml += '<div class="stat-card"><div class="stat-value">' + summary.max.display + '</div><div class="stat-label">Max</div></div>';
                summaryHtml += '<div class="stat-card"><div class="stat-value">' + summary.avg + '</div><div class="stat-label">Average</div></div>';
                summaryHtml += '<div class="stat-card"><div class="stat-value">' + summary.median.display + '</div><div class="stat-label">Median</div></div>';
            }
            document.getElementById('voteSummary').innerHTML = summaryHtml;
            
            // Render vote distribution
            var distributionHtml = '';
            votes.forEach(function(vote) {
                distributionHtml += '<span class="vote-chip">' + vote.voterName + ': ' + vote.voteValue + '</span>';
            });
            document.getElementById('voteDistribution').innerHTML = distributionHtml;
        }
        
        // Update dealer controls based on story status
        function updateDealerControls(currentStory) {
            var startBtn = document.getElementById('startVotingBtn');
            var revealBtn = document.getElementById('revealVotesBtn');
            var resetBtn = document.getElementById('resetVotesBtn');
            var skipBtn = document.getElementById('skipStoryBtn');
            var completeBtn = document.getElementById('completeStoryBtn');
            
            if (!currentStory) {
                startBtn.disabled = true;
                revealBtn.disabled = true;
                resetBtn.disabled = true;
                skipBtn.disabled = true;
                completeBtn.disabled = true;
                return;
            }
            
            var status = currentStory.status;
            
            startBtn.disabled = (status !== 'pending');
            revealBtn.disabled = (status !== 'voting');
            resetBtn.disabled = (status !== 'revealed');
            skipBtn.disabled = false;
            completeBtn.disabled = (status !== 'revealed');
        }
        
        // --- Story Queue Rendering ---
        
        function renderStoryQueue(stories) {
            var container = document.getElementById('storyQueue');
            container.innerHTML = '';
            
            if (!stories || stories.length === 0) {
                container.innerHTML = '<div style="padding:0.5rem;color:rgba(200,214,229,0.4);font-family:Share Tech Mono,monospace;font-size:0.85rem;letter-spacing:1px;">// No objectives loaded</div>';
                return;
            }
            
            var currentStoryId = sessionData && sessionData.currentStory ? sessionData.currentStory.sys_id : null;
            
            stories.forEach(function(story, index) {
                var div = document.createElement('div');
                var isCurrent = story.sys_id === currentStoryId;
                var statusIcon = '';
                var statusColor = '';
                
                switch (story.status) {
                    case 'completed':
                        statusIcon = '‚úì'; statusColor = 'var(--success-color)'; break;
                    case 'voting':
                        statusIcon = '‚ñ∂'; statusColor = 'var(--warning-color)'; break;
                    case 'revealed':
                        statusIcon = '‚óâ'; statusColor = 'var(--lcars-orange)'; break;
                    case 'skipped':
                        statusIcon = '‚äò'; statusColor = 'rgba(200,214,229,0.3)'; break;
                    default:
                        statusIcon = '‚óã'; statusColor = 'rgba(200,214,229,0.5)'; break;
                }
                
                div.style.cssText = 'display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.6rem;border-bottom:1px solid rgba(0,212,255,0.08);border-radius:3px;transition:background 0.15s;' + (isCurrent ? 'background:rgba(0,212,255,0.08);border-left:3px solid var(--primary-color);' : '');
                
                var icon = document.createElement('span');
                icon.style.cssText = 'font-size:0.85rem;color:' + statusColor + ';flex-shrink:0;width:16px;text-align:center;';
                icon.textContent = statusIcon;
                
                var info = document.createElement('div');
                info.style.cssText = 'flex:1;min-width:0;';
                
                var title = document.createElement('div');
                title.style.cssText = 'font-family:Rajdhani,monospace;font-size:0.9rem;font-weight:600;color:' + (isCurrent ? '#e8f0fe' : 'rgba(200,214,229,0.7)') + ';white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
                title.textContent = (story.story_number || '') + (story.story_number && story.story_title ? ' ‚Äî ' : '') + (story.story_title || 'Untitled');
                
                var meta = document.createElement('div');
                meta.style.cssText = 'font-family:Share Tech Mono,monospace;font-size:0.65rem;color:rgba(200,214,229,0.4);text-transform:uppercase;letter-spacing:1px;';
                meta.textContent = story.status + (story.story_points ? ' ¬∑ ' + story.story_points + ' pts' : '');
                
                info.appendChild(title);
                info.appendChild(meta);
                div.appendChild(icon);
                div.appendChild(info);
                container.appendChild(div);
            });
        }
        
        // --- Add Objective Functions ---
        
        function searchStoriesForVoting(searchTerm) {
            console.log('[DEBUG VI-search] Searching for:', searchTerm);
            var ga = new GlideAjax('SessionManagementAjax');
            ga.addParam('sysparm_name', 'searchStories');
            ga.addParam('search_term', searchTerm);
            ga.addParam('limit', '15');
            ga.getXML(function(response) {
                console.log('[DEBUG VI-search] Raw response:', response);
                var result = parseAjaxResponse(response);
                console.log('[DEBUG VI-search] Parsed result:', result);
                if (!result || !result.success) {
                    console.warn('[DEBUG VI-search] No result or not successful:', result);
                    document.getElementById('storySearchResults').innerHTML = '<div style="padding:0.5rem;color:#ff6b6b;">Error searching objectives</div>';
                    return;
                }
                
                var container = document.getElementById('storySearchResults');
                container.innerHTML = '';
                selectedStoryIds = [];
                
                if (result.data.length === 0) {
                    container.innerHTML = '<div style="padding:0.75rem;color:rgba(200,214,229,0.4);font-family:Share Tech Mono,monospace;font-size:0.85rem;">// No matching objectives found</div>';
                    return;
                }
                
                result.data.forEach(function(story) {
                    var div = document.createElement('div');
                    div.style.cssText = 'padding:0.5rem 0.75rem;border-bottom:1px solid rgba(0,212,255,0.08);display:flex;align-items:center;gap:0.5rem;cursor:pointer;transition:background 0.15s;font-family:Rajdhani,monospace;font-size:0.9rem;';
                    
                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = story.sys_id;
                    checkbox.style.cssText = 'accent-color:var(--primary-color);';
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedStoryIds.push(story.sys_id);
                        } else {
                            selectedStoryIds = selectedStoryIds.filter(function(id) { return id !== story.sys_id; });
                        }
                    });
                    
                    var label = document.createElement('span');
                    label.innerHTML = '<strong>' + escapeHtml(story.number) + '</strong> ‚Äî ' + escapeHtml(story.short_description || 'Untitled');
                    
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    div.addEventListener('click', function(e) {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                    div.addEventListener('mouseenter', function() { div.style.background = 'rgba(0,212,255,0.08)'; });
                    div.addEventListener('mouseleave', function() { div.style.background = ''; });
                    
                    container.appendChild(div);
                });
            });
        }
        
        function addSelectedStoriesToSession() {
            console.log('[DEBUG VI-addSelected] selectedStoryIds:', selectedStoryIds, 'sessionId:', sessionId);
            if (selectedStoryIds.length === 0) {
                showToast('Select at least one objective', 'error');
                return;
            }
            
            var ga = new GlideAjax('SessionManagementAjax');
            ga.addParam('sysparm_name', 'addStories');
            ga.addParam('session_id', sessionId);
            ga.addParam('story_ids', selectedStoryIds.join(','));
            console.log('[DEBUG VI-addSelected] Sending AJAX: session_id=' + sessionId + ', story_ids=' + selectedStoryIds.join(','));
            ga.getXML(function(response) {
                console.log('[DEBUG VI-addSelected] Raw response:', response);
                var result = parseAjaxResponse(response);
                console.log('[DEBUG VI-addSelected] Parsed result:', result);
                if (!result) { showToast('Error adding objectives', 'error'); return; }
                
                if (result.success) {
                    console.log('[DEBUG VI-addSelected] Success!');
                    showToast('Objectives added to mission', 'success');
                    selectedStoryIds = [];
                    hideAllModals();
                    loadSession(); // Refresh to show new stories
                } else {
                    showToast(result.message, 'error');
                }
            });
        }
        
        function quickAddStoryToSession() {
            var title = document.getElementById('quickStoryTitle').value.trim();
            var description = document.getElementById('quickStoryDescription').value.trim();
            console.log('[DEBUG VI-quickAdd] title:', title, 'sessionId:', sessionId);
            
            if (!title) {
                showToast('Objective title is required', 'error');
                return;
            }
            
            var ga = new GlideAjax('SessionManagementAjax');
            ga.addParam('sysparm_name', 'addManualStory');
            ga.addParam('session_id', sessionId);
            ga.addParam('title', title);
            ga.addParam('description', description);
            console.log('[DEBUG VI-quickAdd] Sending AJAX: session_id=' + sessionId + ', title=' + title);
            ga.getXML(function(response) {
                console.log('[DEBUG VI-quickAdd] Raw response:', response);
                var result = parseAjaxResponse(response);
                console.log('[DEBUG VI-quickAdd] Parsed result:', result);
                if (!result) { showToast('Error adding objective', 'error'); return; }
                
                if (result.success) {
                    console.log('[DEBUG VI-quickAdd] Success!');
                    showToast('Objective deployed', 'success');
                    document.getElementById('quickStoryTitle').value = '';
                    document.getElementById('quickStoryDescription').value = '';
                    hideAllModals();
                    loadSession(); // Refresh to show new story
                } else {
                    showToast(result.message, 'error');
                }
            });
        }
        
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text || ''));
            return div.innerHTML;
        }
        
        // Utility functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        function hideAllModals() {
            var modals = document.querySelectorAll('.modal');
            modals.forEach(function(modal) {
                modal.classList.remove('show');
            });
        }
        
        var _toastTimer = null;
        function showToast(message, type) {
            var toast = document.getElementById('toast');
            var toastMessage = document.getElementById('toastMessage');
            
            if (_toastTimer) { clearTimeout(_toastTimer); _toastTimer = null; }
            
            toastMessage.textContent = message;
            toast.className = 'toast toast-' + type + ' show';
            
            _toastTimer = setTimeout(function() {
                toast.classList.remove('show');
                _toastTimer = null;
            }, 3000);
        }
        
        function copyJoinLink() {
            if (!sessionData || !sessionData.session) {
                showToast('Session data not loaded yet', 'error');
                return;
            }
            var sessionCode = sessionData.session.sessionCode;
            var joinUrl = window.location.protocol + '//' + window.location.host + '/join.do?session_code=' + sessionCode;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(joinUrl).then(function() {
                    showToast('Docking coordinates transmitted', 'success');
                });
            } else {
                // Fallback for older browsers
                var textArea = document.createElement('textarea');
                textArea.value = joinUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Docking coordinates transmitted', 'success');
            }
        }
        
        function toggleTheme() {
            document.body.classList.toggle('red-alert');
            showToast(document.body.classList.contains('red-alert') ? 'RED ALERT activated' : 'Red alert disengaged', 'info');
        }
        
        function switchRole() {
            showToast('Role switching not yet operational', 'info');
        }
        
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        });
    //]]>
    </script>
</body>
</html>
</j:jelly>